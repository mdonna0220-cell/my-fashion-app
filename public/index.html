<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æœé¥°è®¾è®¡åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
            color: #1f2937;
        }
        .container {
            max-width: 960px;
            position: relative; 
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary { background-color: #4f46e5; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-tertiary { background-color: #dc2626; }
        .btn-tertiary:hover { background-color: #b91c1c; }
        .btn-tertiary:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-quaternary { background-color: #f97316; }
        .btn-quaternary:hover { background-color: #ea580c; }
        .btn-quaternary:disabled { background-color: #fdba74; cursor: not-allowed; }
        .btn-quintenary { background-color: #10b981; }
        .btn-quintenary:hover { background-color: #059669; }
        .btn-sidenary { background-color: #8b5cf6; }
        .btn-sidenary:hover { background-color: #7c3aed; }
        .btn-heptanary { background-color: #0891b2; }
        .btn-heptanary:hover { background-color: #0e7490; }

        #loading-message { color: #4f46e5; }
        #image-container img, #detail-image-container img, #uploaded-image-preview, #i2i-generated-image, #lineart-upload-generated-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #story-container { min-height: 100px; overflow-y: auto; }
        .modal { background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { max-width: 80%; max-height: 80%; overflow-y: auto; }
        .vocab-button {
            background-color: #e5e7eb;
            color: #1f2937;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .vocab-button:hover { background-color: #d1d5db; }
        .vocab-button.clicked {
            background-color: #8b5cf6;
            color: white;
            transform: scale(1.05);
        }
        
        #notebook-toggle, #encyclopedia-toggle {
            position: absolute;
            top: 1rem;
            z-index: 20;
            cursor: pointer;
        }
        #notebook-toggle { right: 1rem; }
        #encyclopedia-toggle { left: 1rem; }

        #notebook-panel {
            position: absolute;
            top: 4rem;
            right: 1rem;
            width: 300px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 1rem;
            z-index: 50;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .upload-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.2s ease;
        }
        .upload-zone:hover {
            border-color: #8b5cf6;
            background-color: #f5f3ff;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto bg-white p-8 rounded-2xl shadow-2xl space-y-8">
        
        <!-- PAGE 1: Main App -->
        <div id="main-page">
            <div id="notebook-toggle" class="p-2 rounded-full hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            </div>
            
            <div id="encyclopedia-toggle" class="p-2 rounded-full hover:bg-gray-100">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-8.494h18m-18 5.494h18M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
            </div>

            <div id="notebook-panel" class="hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-2">çµæ„Ÿç¬”è®°æœ¬</h3>
                <textarea id="notebook-textarea" class="w-full h-48 p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-purple-400" placeholder="åœ¨è¿™é‡Œè®°å½•ä½ çš„çµæ„Ÿå…³é”®è¯..."></textarea>
                <div class="flex justify-between items-center mt-2">
                    <span id="notebook-status" class="text-sm text-green-600 opacity-0 transition-opacity">å·²ä¿å­˜!</span>
                    <div>
                        <button id="notebook-copy-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-secondary">ä¸€é”®å¤åˆ¶</button>
                        <button id="notebook-clear-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-tertiary">æ¸…ç©º</button>
                    </div>
                </div>
            </div>

            <header class="text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">AI æœé¥°è®¾è®¡åŠ©æ‰‹ ğŸ‘•</h1>
                <p class="mt-2 text-gray-600">è¾“å…¥ä½ çš„æœè£…è®¾è®¡æƒ³æ³•ï¼Œç”Ÿæˆä¸“ä¸šçš„è®¾è®¡å›¾å’Œè¯´æ˜ã€‚</p>
                <p class="mt-2 text-sm text-gray-500">ä»Šæ—¥å‰©ä½™æ¬¡æ•°: <span id="api-usage-counter">--</span></p>
            </header>
            
            <div class="text-center">
                <button id="go-to-i2i" class="inline-block px-6 py-2 text-white font-bold rounded-full shadow-lg btn btn-heptanary">åˆ‡æ¢åˆ°å›¾ç”Ÿå›¾æ¨¡å¼ â†’</button>
            </div>

            <section class="space-y-4">
                <div>
                    <label for="prompt-input" class="block text-sm font-medium text-gray-700">
                        è¾“å…¥ä½ çš„æœè£…è®¾è®¡æƒ³æ³•ï¼š
                    </label>
                    <textarea id="prompt-input" rows="4" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 transition-colors" placeholder="ä¾‹å¦‚: ä¸€ä»¶èµ›åšæœ‹å…‹é£æ ¼çš„æœªæ¥æ´¾å¤¹å…‹ï¼Œå¸¦æœ‰éœ“è™¹ç¯å¸¦ï¼Œç”±åå…‰é¢æ–™åˆ¶æˆ"></textarea>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <button id="refine-btn" class="w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-tertiary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <span>çµæ„Ÿè¯åº“ ğŸ“š</span>
                    </button>
                    <button id="translate-btn" class="w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" disabled>
                        <span>ç”Ÿæˆæç¤ºè¯ âœ¨</span>
                    </button>
                    <button id="generate-btn" class="w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-quaternary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500" disabled>
                        <span>ç”Ÿæˆè®¾è®¡å›¾ âœ¨</span>
                    </button>
                    <button id="lineart-btn" class="w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-sidenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <span>è®¾è®¡çº¿ç¨¿ âœ’ï¸</span>
                    </button>
                </div>
            </section>

            <section class="space-y-4">
                <div id="loading-container" class="text-center" style="display: none;">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-gray-400 border-t-indigo-600"></div>
                    <p id="loading-message" class="mt-2 text-sm font-medium">æ­£åœ¨åŠ è½½...</p>
                </div>
                
                <div id="result-container" class="space-y-4">
                    <div id="english-prompt-box" class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg hidden">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-700">ä¼˜åŒ–åçš„è‹±æ–‡æç¤ºè¯ï¼š</p>
                                <p id="english-prompt" class="mt-1 text-gray-900 break-words pr-4"></p>
                            </div>
                            <button id="copy-prompt-btn" class="ml-4 flex-shrink-0 px-4 py-1.5 text-sm font-semibold text-white rounded-full btn btn-secondary">å¤åˆ¶</button>
                        </div>
                    </div>

                    <div id="image-container" class="w-full h-auto flex justify-center items-center">
                        <img id="generated-image" class="hidden" alt="Generated AI Image">
                    </div>
                    
                    <div id="detail-image-container" class="w-full h-auto flex justify-center items-center mt-4">
                        <div class="relative w-full">
                             <h4 id="detail-image-title" class="font-bold text-gray-700 mb-2 text-center hidden">ä¿®æ”¹åï¼š</h4>
                            <img id="detail-image" class="hidden mx-auto" alt="Detailed AI Image">
                        </div>
                    </div>

                    <div id="story-buttons-container" class="flex flex-col space-y-2 mt-4 hidden">
                        <label for="story-prompt-input" class="block text-sm font-medium text-gray-700">
                            è®¾è®¡è¯´æ˜æŒ‡ä»¤ (å¯ç¼–è¾‘)ï¼š
                        </label>
                        <textarea id="story-prompt-input" rows="2" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 story-prompt-textarea focus:border-indigo-500 focus:ring-indigo-500 transition-colors"></textarea>
                        <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-2 mt-4 relative">
                            <button id="story-btn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base sm:text-lg font-bold text-white btn-tertiary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" disabled>
                                <span>ç”Ÿæˆè®¾è®¡è¯´æ˜ âœ¨</span>
                            </button>
                            <button id="detail-btn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base sm:text-lg font-bold text-white btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" disabled>
                                <span>æ·±åŒ–è®¾è®¡ç»†èŠ‚ ğŸ”¬</span>
                            </button>
                            <div id="detail-options" class="absolute top-full mt-2 w-full sm:w-auto bg-white rounded-md shadow-lg z-10 hidden">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚... (æ‰‹åŠ¨è¾“å…¥)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show a macro close-up of the fabric texture.">æ”¾å¤§é¢æ–™ç»†èŠ‚</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show the back view of this garment.">å±•ç¤ºæœè£…èƒŒé¢</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show the side profile of this garment.">å±•ç¤ºæœè£…ä¾§é¢</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show this garment on a runway model.">å±•ç¤ºæ¨¡ç‰¹ä¸Šèº«æ•ˆæœ</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show this garment flat lay.">å±•ç¤ºæœè£…å¹³é“ºå›¾</a>
                            </div>
                        </div>
                    </div>

                    <div id="story-container" class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg hidden">
                        <p class="text-sm font-medium text-gray-700">è®¾è®¡è¯´æ˜ï¼š</p>
                        <p id="story-text" class="mt-1 text-gray-900 leading-relaxed whitespace-pre-wrap"></p>
                        <div id="story-action-buttons" class="flex justify-center mt-4 hidden">
                            <button id="copy-story-btn" class="px-6 py-2 text-sm font-bold text-white rounded-full shadow-lg btn-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                ä¸€é”®å¤åˆ¶
                            </button>
                        </div>
                    </div>

                    <div id="error-message" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                        <p id="error-text" class="text-sm font-medium"></p>
                    </div>
                </div>
            </section>
        </div>

        <!-- PAGE 2: Image-to-Image Studio -->
        <div id="i2i-page" class="hidden">
            <header class="text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">å›¾ç”Ÿå›¾å·¥ä½œå®¤ ğŸ–¼ï¸</h1>
                <p class="mt-2 text-gray-600">ä¸Šä¼ å›¾ç‰‡ï¼Œåˆ†æé£æ ¼ï¼Œè·å–å…¨æ–°åˆ›ä½œçµæ„Ÿã€‚</p>
            </header>
            <div class="text-center mt-4">
                <button id="go-to-main" class="inline-block px-6 py-2 text-white font-bold rounded-full shadow-lg btn btn-secondary">â† è¿”å›æ–‡æœ¬åˆ›ä½œæ¨¡å¼</button>
            </div>
            <section id="image-to-image-section" class="space-y-4 pt-6">
                <div class="flex flex-col items-center gap-6">
                    <div class="w-full max-w-md">
                        <label for="i2i-image-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                        </label>
                        <input type="file" id="i2i-image-upload-input" class="hidden" accept="image/*">
                        <div id="uploaded-image-container" class="hidden text-center mt-4">
                             <img id="uploaded-image-preview" class="mx-auto" alt="Uploaded Image Preview">
                        </div>
                    </div>
                    <div class="w-full max-w-md space-y-4">
                        <div class="flex flex-col sm:flex-row gap-2 relative">
                            <button id="analyze-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" disabled>åˆ†æå›¾ç‰‡</button>
                            <button id="direct-modify-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-heptanary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500" disabled>è¿›ä¸€æ­¥ä¿®æ”¹</button>
                            <div id="direct-modify-options" class="absolute top-full mt-2 w-full sm:w-auto bg-white rounded-md shadow-lg z-10 hidden">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚... (æ‰‹åŠ¨è¾“å…¥)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show a macro close-up of the texture.">æ”¾å¤§ç»†èŠ‚</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show the back view.">å±•ç¤ºèƒŒé¢</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Change the color to [COLOR].">æ›´æ¢é¢œè‰²</a>
                            </div>
                        </div>
                        
                        <div id="analysis-container" class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg hidden">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-gray-700">AIè®¾è®¡åˆ†æ (å¯ç¼–è¾‘)ï¼š</h4>
                                <button id="copy-analysis-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-secondary">ä¸€é”®å¤åˆ¶</button>
                            </div>
                            <textarea id="analysis-text" rows="5" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                            <button id="generate-from-analysis-btn" class="w-full mt-2 py-2 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">æ ¹æ®åˆ†æç”Ÿæˆæ–°è®¾è®¡</button>
                        </div>
                         <div id="i2i-generated-image-container" class="hidden text-center">
                            <div class="flex flex-col gap-4 items-center">
                                <div id="i2i-before-container" class="hidden w-full">
                                    <h4 class="font-bold text-gray-700 mb-2">ä¿®æ”¹å‰</h4>
                                    <img id="i2i-before-image" class="mx-auto rounded-lg shadow-md" alt="Image before modification">
                                </div>
                                <div id="i2i-after-container" class="w-full">
                                    <h4 id="i2i-after-title" class="font-bold text-gray-700 mb-2">ç”Ÿæˆçš„æ–°è®¾è®¡</h4>
                                    <img id="i2i-generated-image" class="mx-auto rounded-lg shadow-md" alt="Image-to-Image Generated Image">
                                </div>
                            </div>
                        </div>
                         <div id="i2i-loading-container" class="text-center" style="display: none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-gray-400 border-t-green-600"></div>
                            <p id="i2i-loading-message" class="mt-2 text-sm font-medium text-green-600">æ­£åœ¨åŠ è½½...</p>
                        </div>
                        <div id="i2i-detail-controls" class="hidden flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-2 mt-4 relative">
                            <button id="i2i-detail-btn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base sm:text-lg font-bold text-white btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <span>ä¿®æ”¹æ¶¦è‰² ğŸ¨</span>
                            </button>
                            <div id="i2i-detail-options" class="absolute top-full mt-2 w-full sm:w-auto bg-white rounded-md shadow-lg z-10 hidden">
                                 <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚... (æ‰‹åŠ¨è¾“å…¥)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show a macro close-up of the fabric texture.">æ”¾å¤§é¢æ–™ç»†èŠ‚</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show the back view of this garment.">å±•ç¤ºæœè£…èƒŒé¢</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Change the main color.">æ”¹å˜ä¸»è‰²è°ƒ</a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- MODALS (Shared between pages) -->
        <div id="vocab-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-2xl bg-white space-y-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-2xl font-bold text-gray-900">æœé¥°è®¾è®¡çµæ„Ÿè¯åº“</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div id="style-type-container" class="space-y-4"> <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="style-type-buttons">æ¬¾å¼ç±»åˆ« (Garment Type)</h4> <div id="style-type-buttons" class="flex flex-wrap gap-2"></div> </div>
                <div id="aesthetic-container" class="space-y-4"> <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="aesthetic-buttons">è®¾è®¡é£æ ¼ (Aesthetic)</h4> <div id="aesthetic-buttons" class="flex flex-wrap gap-2"></div> </div>
                <div id="material-container" class="space-y-4"> <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="material-buttons">é¢æ–™æè´¨ (Material)</h4> <div id="material-buttons" class="flex flex-wrap gap-2"></div> </div>
                <div id="pattern-container" class="space-y-4"> <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="pattern-buttons">å›¾æ¡ˆå°èŠ± (Pattern/Print)</h4> <div id="pattern-buttons" class="flex flex-wrap gap-2"></div> </div>
                <div id="details-container" class="space-y-4"> <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="details-buttons">ç»†èŠ‚å‰ªè£ (Details/Cut)</h4> <div id="details-buttons" class="flex flex-wrap gap-2"></div> </div>
                <div id="color-container" class="space-y-4"> <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="color-buttons">è‰²å½©æ­é… (Color)</h4> <div id="color-buttons" class="flex flex-wrap gap-2"></div> </div>
            </div>
        </div>

        <div id="custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™è¿™ä»¶å¤¹å…‹åŠ ä¸Šå…œå¸½"></textarea> </div>
                <div class="flex justify-end"> <button id="submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆç»†èŠ‚å›¾</button> </div>
            </div>
        </div>
        
        <div id="i2i-custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="i2i-close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="i2i-custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šæŠŠè¿™ä»¶Tæ¤çš„é¢œè‰²æ”¹æˆé»‘è‰²"></textarea> </div>
                <div class="flex justify-end"> <button id="i2i-submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆç»†èŠ‚å›¾</button> </div>
            </div>
        </div>

        <div id="lineart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
             <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-2xl bg-white space-y-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">è®¾è®¡çº¿ç¨¿ç”Ÿæˆå™¨ âœ’ï¸</h3>
                    <button id="close-lineart-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                
                <div class="p-4 border-b border-gray-200">
                    <h4 class="text-xl font-semibold mb-2 text-center">ä»æ–‡æœ¬ç”Ÿæˆçº¿ç¨¿</h4>
                    <div class="flex space-x-2">
                        <input type="text" id="lineart-input" class="flex-grow rounded-full border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è¾“å…¥è®¾è®¡ä¸»é¢˜ï¼Œä¾‹å¦‚ï¼šä¸€ä»¶è¿è¡£è£™">
                        <button id="lineart-generate-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-sidenary">ç”Ÿæˆçº¿ç¨¿</button>
                    </div>
                </div>
                <div id="lineart-loading" class="text-center py-4 hidden">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-gray-400 border-t-purple-600"></div>
                    <p id="lineart-loading-message" class="mt-2 text-sm font-medium text-purple-600">æ­£åœ¨ç”Ÿæˆ...</p>
                </div>
                <div id="lineart-results" class="space-y-4 p-2 text-center">
                    <!-- Text-generated lineart results will be injected here -->
                </div>

                <hr class="my-4">

                <div class="p-4">
                    <h4 class="text-xl font-semibold mb-2 text-center">ä¸Šä¼ çº¿ç¨¿å†åˆ›ä½œ</h4>
                     <div class="w-full max-w-md mx-auto">
                        <label for="lineart-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                        </label>
                        <input type="file" id="lineart-upload-input" class="hidden" accept="image/*">
                        <div id="lineart-upload-preview-container" class="hidden text-center mt-4">
                             <img id="lineart-upload-preview" class="mx-auto rounded-lg shadow-md" alt="Uploaded Image Preview">
                        </div>
                    </div>
                    <div class="w-full max-w-md mx-auto space-y-4 mt-4">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="lineart-upload-analyze-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" disabled>åˆ†æå›¾ç‰‡</button>
                            <div class="relative w-full">
                                <button id="lineart-upload-modify-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-heptanary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500" disabled>ä¿®æ”¹å›¾ç‰‡</button>
                                <div id="lineart-upload-modify-options" class="absolute top-full mt-2 w-full bg-white rounded-md shadow-lg z-10 hidden">
                                     <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold">æ‰‹å·¥è¾“å…¥ç»†èŠ‚ä¿®æ”¹</a>
                                </div>
                            </div>
                        </div>
                        
                        <div id="lineart-upload-analysis-container" class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg hidden">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-gray-700">AIè®¾è®¡åˆ†æ (å¯ç¼–è¾‘)ï¼š</h4>
                                <button id="lineart-upload-copy-analysis-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-secondary">ä¸€é”®å¤åˆ¶</button>
                            </div>
                            <textarea id="lineart-upload-analysis-text" rows="5" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                            <button id="lineart-upload-generate-from-analysis-btn" class="w-full mt-2 py-2 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">æ ¹æ®åˆ†æç”Ÿæˆæ–°è®¾è®¡</button>
                        </div>
                         <div id="lineart-upload-generated-image-container" class="hidden text-center">
                            <div class="flex flex-col gap-4 items-center">
                                <div id="lineart-upload-before-container" class="hidden w-full">
                                    <h4 class="font-bold text-gray-700 mb-2">ä¿®æ”¹å‰</h4>
                                    <img id="lineart-upload-before-image" class="mx-auto rounded-lg shadow-md" alt="Image before modification">
                                </div>
                                <div id="lineart-upload-after-container" class="w-full">
                                    <h4 id="lineart-upload-after-title" class="font-bold text-gray-700 mb-2">ç”Ÿæˆçš„æ–°è®¾è®¡</h4>
                                    <img id="lineart-upload-generated-image" class="mx-auto rounded-lg shadow-md" alt="Image-to-Image Generated Image">
                                </div>
                            </div>
                        </div>
                        <div id="lineart-upload-loading" class="text-center py-4 hidden">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-gray-400 border-t-green-600"></div>
                            <p id="lineart-upload-loading-message" class="mt-2 text-sm font-medium text-green-600">æ­£åœ¨å¤„ç†...</p>
                        </div>
                        <div id="lineart-upload-detail-controls" class="hidden flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-2 mt-4 relative">
                            <button id="lineart-upload-detail-btn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base sm:text-lg font-bold text-white btn-heptanary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                                <span>ä¿®æ”¹æ¶¦è‰² ğŸ¨</span>
                            </button>
                            <div id="lineart-upload-detail-options" class="absolute top-full mt-2 w-full sm:w-auto bg-white rounded-md shadow-lg z-10 hidden">
                                 <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚... (æ‰‹åŠ¨è¾“å…¥)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Color this line art with a simple, flat color palette.">ä¸€é”®ä¸Šè‰²</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Redraw this in a more minimalist, simplified style.">æ›´æç®€</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Redraw this with more intricate and exquisite details.">æ›´ç²¾è‡´</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="lineart-custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="lineart-close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="lineart-custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™è¿™ä»¶è¡£æœä¸Šè‰²"></textarea> </div>
                <div class="flex justify-end"> <button id="lineart-submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆ</button> </div>
            </div>
        </div>

        <div id="lineart-upload-custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="lineart-upload-close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="lineart-upload-custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šæŠŠè¢–å­æ”¹æˆæ³¡æ³¡è¢–"></textarea> </div>
                <div class="flex justify-end"> <button id="lineart-upload-submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆ</button> </div>
            </div>
        </div>
        
        <div id="encyclopedia-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">æ—¶å°šç™¾ç§‘å…¨ä¹¦ ğŸ“–</h3>
                    <button id="close-encyclopedia-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="flex space-x-2">
                    <input type="text" id="encyclopedia-input" class="flex-grow rounded-full border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è¾“å…¥å…³é”®è¯æœç´¢ï¼Œä¾‹å¦‚ï¼šé¦™å¥ˆå„¿">
                    <button id="encyclopedia-search-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-primary">æœç´¢</button>
                </div>
                <div id="encyclopedia-loading" class="text-center py-4 hidden">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-gray-400 border-t-blue-600"></div>
                    <p class="mt-2 text-sm font-medium text-blue-600">æ­£åœ¨æ£€ç´¢ä¿¡æ¯åº“...</p>
                </div>
                <div id="encyclopedia-results" class="space-y-4 max-h-[60vh] overflow-y-auto p-2">
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- API å®‰å…¨ä¿®æ­£: APIç«¯ç‚¹ç°åœ¨æŒ‡å‘æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨ ---
        const GEMINI_API_URL = '/api/generateContent/gemini-2.5-flash-preview-05-20';
        const IMAGE_GENERATION_API_URL = '/api/generateContent/gemini-2.5-flash-image-preview';
        
        const DAILY_API_LIMIT = 200; // æ¯æ—¥ä½¿ç”¨ä¸Šé™
        const USAGE_STORAGE_KEY = 'fashionApiUsage'; // æœ¬åœ°å­˜å‚¨çš„é”®
        
        // --- DOM å…ƒç´ é€‰æ‹© ---
        const apiUsageCounter = document.getElementById('api-usage-counter');
        const mainPage = document.getElementById('main-page');
        const i2iPage = document.getElementById('i2i-page');
        const promptInput = document.getElementById('prompt-input');
        const translateBtn = document.getElementById('translate-btn');
        const refineBtn = document.getElementById('refine-btn');
        const generateBtn = document.getElementById('generate-btn');
        const storyBtn = document.getElementById('story-btn');
        const detailBtn = document.getElementById('detail-btn');
        const detailOptions = document.getElementById('detail-options');
        const loadingContainer = document.getElementById('loading-container');
        const loadingMessage = document.getElementById('loading-message');
        const englishPromptBox = document.getElementById('english-prompt-box');
        const englishPrompt = document.getElementById('english-prompt');
        const copyPromptBtn = document.getElementById('copy-prompt-btn');
        const imageContainer = document.getElementById('image-container');
        const generatedImage = document.getElementById('generated-image');
        const detailImageContainer = document.getElementById('detail-image-container');
        const detailImage = document.getElementById('detail-image');
        const detailImageTitle = document.getElementById('detail-image-title');
        const storyContainer = document.getElementById('story-container');
        const storyButtonsContainer = document.getElementById('story-buttons-container');
        const storyText = document.getElementById('story-text');
        const storyPromptInput = document.getElementById('story-prompt-input');
        const copyStoryBtn = document.getElementById('copy-story-btn');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // --- æ¨¡æ€æ¡†å…ƒç´  ---
        const vocabModal = document.getElementById('vocab-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const customDetailModal = document.getElementById('custom-detail-modal');
        const closeCustomModalBtn = document.getElementById('close-custom-modal-btn');
        const customDetailInput = document.getElementById('custom-detail-input');
        const submitCustomDetailBtn = document.getElementById('submit-custom-detail');
        const encyclopediaModal = document.getElementById('encyclopedia-modal');
        const encyclopediaToggle = document.getElementById('encyclopedia-toggle');
        const closeEncyclopediaModalBtn = document.getElementById('close-encyclopedia-modal-btn');
        const encyclopediaInput = document.getElementById('encyclopedia-input');
        const encyclopediaSearchBtn = document.getElementById('encyclopedia-search-btn');
        const encyclopediaLoading = document.getElementById('encyclopedia-loading');
        const encyclopediaResults = document.getElementById('encyclopedia-results');
        
        // --- çº¿ç¨¿æ¨¡æ€æ¡†å…ƒç´  ---
        const lineartModal = document.getElementById('lineart-modal');
        const lineartBtn = document.getElementById('lineart-btn');
        const closeLineartModalBtn = document.getElementById('close-lineart-modal-btn');
        const lineartInput = document.getElementById('lineart-input');
        const lineartGenerateBtn = document.getElementById('lineart-generate-btn');
        const lineartLoading = document.getElementById('lineart-loading');
        const lineartLoadingMessage = document.getElementById('lineart-loading-message');
        const lineartResults = document.getElementById('lineart-results');
        const lineartCustomDetailModal = document.getElementById('lineart-custom-detail-modal');
        const lineartCloseCustomModalBtn = document.getElementById('lineart-close-custom-modal-btn');
        const lineartCustomDetailInput = document.getElementById('lineart-custom-detail-input');
        const lineartSubmitCustomDetailBtn = document.getElementById('lineart-submit-custom-detail');

        // --- çº¿ç¨¿ä¸Šä¼ ä¸å›¾ç”Ÿå›¾å…ƒç´  ---
        const lineartUploadInput = document.getElementById('lineart-upload-input');
        const lineartUploadPreviewContainer = document.getElementById('lineart-upload-preview-container');
        const lineartUploadPreview = document.getElementById('lineart-upload-preview');
        const lineartUploadAnalyzeBtn = document.getElementById('lineart-upload-analyze-btn');
        const lineartUploadModifyBtn = document.getElementById('lineart-upload-modify-btn');
        const lineartUploadModifyOptions = document.getElementById('lineart-upload-modify-options');
        const lineartUploadLoading = document.getElementById('lineart-upload-loading');
        const lineartUploadLoadingMessage = document.getElementById('lineart-upload-loading-message');
        const lineartUploadAnalysisContainer = document.getElementById('lineart-upload-analysis-container');
        const lineartUploadAnalysisText = document.getElementById('lineart-upload-analysis-text');
        const lineartUploadGenerateFromAnalysisBtn = document.getElementById('lineart-upload-generate-from-analysis-btn');
        const lineartUploadGeneratedImageContainer = document.getElementById('lineart-upload-generated-image-container');
        const lineartUploadBeforeContainer = document.getElementById('lineart-upload-before-container');
        const lineartUploadBeforeImage = document.getElementById('lineart-upload-before-image');
        const lineartUploadAfterContainer = document.getElementById('lineart-upload-after-container');
        const lineartUploadAfterTitle = document.getElementById('lineart-upload-after-title');
        const lineartUploadGeneratedImage = document.getElementById('lineart-upload-generated-image');
        const lineartUploadDetailControls = document.getElementById('lineart-upload-detail-controls');
        const lineartUploadDetailBtn = document.getElementById('lineart-upload-detail-btn');
        const lineartUploadDetailOptions = document.getElementById('lineart-upload-detail-options');
        const lineartUploadCustomDetailModal = document.getElementById('lineart-upload-custom-detail-modal');
        const lineartUploadCloseCustomModalBtn = document.getElementById('lineart-upload-close-custom-modal-btn');
        const lineartUploadCustomDetailInput = document.getElementById('lineart-upload-custom-detail-input');
        const lineartUploadSubmitCustomDetailBtn = document.getElementById('lineart-upload-submit-custom-detail');
        const lineartUploadCopyAnalysisBtn = document.getElementById('lineart-upload-copy-analysis-btn');


        // --- ç¬”è®°æœ¬å…ƒç´  ---
        const notebookToggle = document.getElementById('notebook-toggle');
        const notebookPanel = document.getElementById('notebook-panel');
        const notebookTextarea = document.getElementById('notebook-textarea');
        const notebookStatus = document.getElementById('notebook-status');
        const notebookCopyBtn = document.getElementById('notebook-copy-btn');
        const notebookClearBtn = document.getElementById('notebook-clear-btn');
        
        // --- å›¾ç”Ÿå›¾å…ƒç´  ---
        const i2iImageUploadInput = document.getElementById('i2i-image-upload-input');
        const uploadedImageContainer = document.getElementById('uploaded-image-container');
        const uploadedImagePreview = document.getElementById('uploaded-image-preview');
        const analyzeBtn = document.getElementById('analyze-btn');
        const generateFromAnalysisBtn = document.getElementById('generate-from-analysis-btn');
        const directModifyBtn = document.getElementById('direct-modify-btn');
        const directModifyOptions = document.getElementById('direct-modify-options');
        const analysisContainer = document.getElementById('analysis-container');
        const analysisText = document.getElementById('analysis-text');
        const i2iGeneratedImageContainer = document.getElementById('i2i-generated-image-container');
        const i2iBeforeContainer = document.getElementById('i2i-before-container');
        const i2iBeforeImage = document.getElementById('i2i-before-image');
        const i2iAfterContainer = document.getElementById('i2i-after-container');
        const i2iAfterTitle = document.getElementById('i2i-after-title');
        const i2iGeneratedImage = document.getElementById('i2i-generated-image');
        const i2iDetailControls = document.getElementById('i2i-detail-controls');
        const i2iDetailBtn = document.getElementById('i2i-detail-btn');
        const i2iDetailOptions = document.getElementById('i2i-detail-options');
        const i2iCustomDetailModal = document.getElementById('i2i-custom-detail-modal');
        const i2iCloseCustomModalBtn = document.getElementById('i2i-close-custom-modal-btn');
        const i2iCustomDetailInput = document.getElementById('i2i-custom-detail-input');
        const i2iSubmitCustomDetailBtn = document.getElementById('i2i-submit-custom-detail');
        const i2iLoadingContainer = document.getElementById('i2i-loading-container');
        const i2iLoadingMessage = document.getElementById('i2i-loading-message');
        const copyAnalysisBtn = document.getElementById('copy-analysis-btn');

        // --- è¯åº“å…ƒç´  ---
        const styleTypeButtonsContainer = document.getElementById('style-type-buttons');
        const aestheticButtonsContainer = document.getElementById('aesthetic-buttons');
        const materialButtonsContainer = document.getElementById('material-buttons');
        const patternButtonsContainer = document.getElementById('pattern-buttons');
        const detailsButtonsContainer = document.getElementById('details-buttons');
        const colorButtonsContainer = document.getElementById('color-buttons');
        const styleTypeTitle = document.querySelector('[data-target="style-type-buttons"]');
        const aestheticTitle = document.querySelector('[data-target="aesthetic-buttons"]');
        const materialTitle = document.querySelector('[data-target="material-buttons"]');
        const patternTitle = document.querySelector('[data-target="pattern-buttons"]');
        const detailsTitle = document.querySelector('[data-target="details-buttons"]');
        const colorTitle = document.querySelector('[data-target="color-buttons"]');


        // --- çŠ¶æ€å˜é‡ ---
        let currentImageData = null;
        let currentLineArtData = null; 
        let uploadedImageData = null; 
        let currentI2IImageData = null;
        let baseI2IImageData = null; 
        let uploadedLineartImageData = null;
        let currentLineartUploadI2IImageData = null;
        let baseLineartUploadI2IImageData = null;
        let originalAnalysisPrompt = ''; 

        // --- æ—¶å°šè¯åº“æ•°æ® ---
        const vocabData = {
            'æ¬¾å¼ç±»åˆ«': { 'Tæ¤': 'T-shirt', 'è¿è¡£è£™': 'Dress', 'å¤¹å…‹': 'Jacket', 'é£è¡£': 'Trench coat', 'å«è¡£': 'Hoodie', 'è£¤å­': 'Pants', 'åŠèº«è£™': 'Skirt', 'è¥¿è£…': 'Blazer', 'è¡¬è¡«': 'Shirt', 'æ¯›è¡£': 'Sweater' },
            'è®¾è®¡é£æ ¼': { 'èµ›åšæœ‹å…‹': 'Cyberpunk', 'å“¥ç‰¹': 'Gothic', 'å¤å¤': 'Vintage', 'æç®€ä¸»ä¹‰': 'Minimalist', 'è¡—å¤´æ½®æµ': 'Streetwear', 'æ³¢è¥¿ç±³äºš': 'Bohemian', 'å­¦é™¢é£': 'Preppy', 'è¿åŠ¨ä¼‘é—²': 'Athleisure', 'æœªæ¥ä¸»ä¹‰': 'Futuristic', 'åºŸåœŸé£': 'Post-apocalyptic' },
            'é¢æ–™æè´¨': { 'ä¸ç»¸': 'Silk', 'ç‰›ä»”å¸ƒ': 'Denim', 'çš®é©': 'Leather', 'æ£‰å¸ƒ': 'Cotton', 'ç¾Šæ¯›': 'Wool', 'ç§‘æŠ€é¢æ–™': 'Techwear fabric', 'é›ªçºº': 'Chiffon', 'å¤©é¹…ç»’': 'Velvet', 'ç½‘çº±': 'Mesh', 'åå…‰ææ–™': 'Reflective material' },
            'å›¾æ¡ˆå°èŠ±': { 'æ ¼çº¹': 'Plaid', 'æ¡çº¹': 'Stripes', 'èŠ±å‰': 'Floral print', 'æŠ½è±¡å‡ ä½•': 'Abstract geometric pattern', 'åŠ¨ç‰©çº¹': 'Animal print', 'æ‰æŸ“': 'Tie-dye', 'çº¯è‰²': 'Solid color', 'logoå°èŠ±': 'Logo print' },
            'ç»†èŠ‚å‰ªè£': { 'ä¸å¯¹ç§°': 'Asymmetrical cut', 'é«˜è…°': 'High-waisted', 'å¤šå£è¢‹': 'Multiple pockets', 'æ‹‰é“¾': 'Zippers', 'å®½æ¾ç‰ˆå‹': 'Oversized fit', 'ä¿®èº«ç‰ˆå‹': 'Slim fit', 'è·å¶è¾¹': 'Ruffles', 'æµè‹': 'Fringes', 'é•‚ç©º': 'Cut-out details', 'æ‹¼æ¥': 'Patchwork' },
            'è‰²å½©æ­é…': { 'è«å…°è¿ªè‰²ç³»': 'Morandi color palette', 'éœ“è™¹è‰²': 'Neon colors', 'é»‘ç™½ç°': 'Monochromatic black and white', 'å¤§åœ°è‰²ç³»': 'Earth tones', 'æ’è‰²': 'Color blocking', 'æ¸å˜è‰²': 'Gradient colors' }
        };

        function createVocabButtons() {
            for (const chineseTerm in vocabData['æ¬¾å¼ç±»åˆ«']) { const button = createButton(chineseTerm); styleTypeButtonsContainer.appendChild(button); }
            for (const chineseTerm in vocabData['è®¾è®¡é£æ ¼']) { const button = createButton(chineseTerm); aestheticButtonsContainer.appendChild(button); }
            for (const chineseTerm in vocabData['é¢æ–™æè´¨']) { const button = createButton(chineseTerm); materialButtonsContainer.appendChild(button); }
            for (const chineseTerm in vocabData['å›¾æ¡ˆå°èŠ±']) { const button = createButton(chineseTerm); patternButtonsContainer.appendChild(button); }
            for (const chineseTerm in vocabData['ç»†èŠ‚å‰ªè£']) { const button = createButton(chineseTerm); detailsButtonsContainer.appendChild(button); }
            for (const chineseTerm in vocabData['è‰²å½©æ­é…']) { const button = createButton(chineseTerm); colorButtonsContainer.appendChild(button); }
        }
        
        function createButton(chineseTerm) {
            const button = document.createElement('button');
            button.textContent = chineseTerm;
            button.className = 'px-4 py-2 text-sm font-medium rounded-full vocab-button';
            button.onclick = () => {
                button.classList.add('clicked');
                setTimeout(() => { button.classList.remove('clicked'); }, 200);

                let currentText = promptInput.value.trim();
                const termToAdd = button.textContent;
                if (currentText && currentText.length > 0) { promptInput.value += `, ${termToAdd}`; } else { promptInput.value = termToAdd; }
                promptInput.dispatchEvent(new Event('input'));
            };
            return button;
        }

        function toggleCategoryButtons(targetId) { if (document.getElementById(targetId)) { document.getElementById(targetId).classList.toggle('hidden'); } }

        styleTypeTitle.addEventListener('click', () => toggleCategoryButtons('style-type-buttons'));
        aestheticTitle.addEventListener('click', () => toggleCategoryButtons('aesthetic-buttons'));
        materialTitle.addEventListener('click', () => toggleCategoryButtons('material-buttons'));
        patternTitle.addEventListener('click', () => toggleCategoryButtons('pattern-buttons'));
        detailsTitle.addEventListener('click', () => toggleCategoryButtons('details-buttons'));
        colorTitle.addEventListener('click', () => toggleCategoryButtons('color-buttons'));

        // --- API ä½¿ç”¨é™åˆ¶å‡½æ•° ---
        function getApiUsage() {
            const usage = localStorage.getItem(USAGE_STORAGE_KEY);
            if (!usage) {
                return { date: new Date().toISOString().split('T')[0], count: 0 };
            }
            return JSON.parse(usage);
        }

        function updateUsageCounterUI() {
            const usage = getApiUsage();
            const today = new Date().toISOString().split('T')[0];
            let remaining;

            if (usage.date === today) {
                remaining = DAILY_API_LIMIT - usage.count;
            } else {
                remaining = DAILY_API_LIMIT;
            }
            
            const displayCount = remaining > 0 ? remaining : 0;
            apiUsageCounter.textContent = displayCount;

            if (displayCount <= 0) {
                apiUsageCounter.classList.add('text-red-600', 'font-bold');
            } else {
                apiUsageCounter.classList.remove('text-red-600', 'font-bold');
            }
        }

        function checkApiLimit() {
            let usage = getApiUsage();
            const today = new Date().toISOString().split('T')[0];

            if (usage.date !== today) {
                // It's a new day, reset the counter
                usage = { date: today, count: 0 };
                localStorage.setItem(USAGE_STORAGE_KEY, JSON.stringify(usage));
                updateUsageCounterUI();
                return true;
            }

            if (usage.count >= DAILY_API_LIMIT) {
                showErrorMessage(`æ‚¨å·²è¾¾åˆ°ä»Šæ—¥ ${DAILY_API_LIMIT} æ¬¡çš„ä½¿ç”¨ä¸Šé™ï¼Œè¯·æ˜å¤©å†æ¥ã€‚`);
                return false;
            }
            return true;
        }

        function incrementApiUsage() {
            let usage = getApiUsage();
            const today = new Date().toISOString().split('T')[0];
            if (usage.date === today) {
                usage.count++;
            } else {
                usage = { date: today, count: 1 };
            }
            localStorage.setItem(USAGE_STORAGE_KEY, JSON.stringify(usage));
            updateUsageCounterUI();
        }


        window.onload = () => {
            createVocabButtons();
            notebookTextarea.value = localStorage.getItem('fashionNotebookContent') || '';
            updateUsageCounterUI();
        };
        
        function setLoadingState(message, showLoading = true, keepImageVisible = false) {
            loadingContainer.style.display = showLoading ? 'block' : 'none';
            loadingMessage.textContent = message;
            
            [translateBtn, refineBtn, generateBtn, storyBtn, detailBtn, lineartBtn, analyzeBtn, directModifyBtn].forEach(btn => btn.disabled = showLoading);
            if (showLoading) {
                if (!keepImageVisible) {
                    englishPromptBox.classList.add('hidden');
                    generatedImage.classList.add('hidden');
                    detailImage.classList.add('hidden');
                }
                storyContainer.classList.add('hidden');
            }
            errorMessage.classList.add('hidden');
        }

        function setI2ILoadingState(message, showLoading = true) {
            i2iLoadingMessage.textContent = message;
            i2iLoadingContainer.style.display = showLoading ? 'block' : 'none';
            [analyzeBtn, directModifyBtn, generateFromAnalysisBtn].forEach(btn => { if(btn) btn.disabled = showLoading });
        }

        function showErrorMessage(message) {
            setLoadingState('', false, true);
            setI2ILoadingState('', false);
            lineartLoading.classList.add('hidden');
            lineartUploadLoading.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            errorText.textContent = `é”™è¯¯: ${message}`;
        }

        const maxRetries = 3;
        const baseDelay = 1000;

        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: `HTTP é”™è¯¯! çŠ¶æ€ç : ${response.status}` } }));
                    if (response.status === 429 && retries < maxRetries) {
                        const delay = baseDelay * Math.pow(2, retries) + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(url, options, retries + 1);
                    }
                    throw new Error(errorData.error?.message || `æœåŠ¡å™¨è¿”å›äº†é”™è¯¯: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                 if (retries < maxRetries && !(error instanceof SyntaxError)) { // Do not retry on JSON parsing errors
                    const delay = baseDelay * Math.pow(2, retries) + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw error;
            }
        }
        
        promptInput.addEventListener('input', () => {
            const hasText = promptInput.value.trim().length > 0;
            translateBtn.disabled = !hasText;
            generateBtn.disabled = !hasText;
        });
        
        async function getEnglishPrompt(showPromptBox = true) {
            if (!checkApiLimit()) return null;
            const chinesePrompt = promptInput.value.trim();
            if (!chinesePrompt) { 
                showErrorMessage("è¯·è¾“å…¥ä½ çš„æœè£…è®¾è®¡æƒ³æ³•ã€‚"); 
                return null; 
            }
            const payload = { contents: [{ parts: [{ text: `Translate the following Chinese text into a moderately detailed and evocative English prompt for an AI image generator specializing in fashion design. The prompt should be a single, flowing sentence or two, focusing on key visual elements like garment type, silhouette, fabric, style, and color palette. Chinese text: "${chinesePrompt}"` }] }] };
            const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            incrementApiUsage();
            const englishText = response.candidates[0].content.parts[0].text.trim();
            if(showPromptBox){
                englishPrompt.textContent = englishText;
                englishPromptBox.classList.remove('hidden');
            }
            return englishText;
        }

        translateBtn.addEventListener('click', async () => {
            setLoadingState('æ­£åœ¨ç”Ÿæˆè‹±æ–‡æç¤ºè¯...');
            try {
                await getEnglishPrompt(true);
            } catch (error) {
                showErrorMessage(error.message);
            } finally {
                setLoadingState('', false);
            }
        });
        
        refineBtn.addEventListener('click', () => { vocabModal.classList.remove('hidden'); });
        closeModalBtn.addEventListener('click', () => { vocabModal.classList.add('hidden'); });
        window.onclick = function(event) { if (event.target === vocabModal) { vocabModal.classList.add('hidden'); } }

        generateBtn.addEventListener('click', async () => {
            setLoadingState('AI æœè£…è®¾è®¡å¸ˆæ­£åœ¨åˆ›ä½œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...');
            storyContainer.classList.add('hidden');
            detailImage.classList.add('hidden');
            englishPromptBox.classList.add('hidden');
            currentImageData = null;
            storyButtonsContainer.classList.add('hidden');
            [storyBtn, detailBtn].forEach(btn => btn.disabled = true);

            try {
                const englishText = await getEnglishPrompt(false);
                if (!englishText) {
                    setLoadingState('', false);
                    return;
                }
                
                if (!checkApiLimit()) return;
                const payload = { contents: [{ parts: [{ text: englishText }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                
                if (base64Data) {
                    generatedImage.src = `data:image/png;base64,${base64Data}`;
                    generatedImage.classList.remove('hidden');
                    currentImageData = base64Data;
                    storyBtn.disabled = false;
                    detailBtn.disabled = false;
                    storyButtonsContainer.classList.remove('hidden');
                } else { 
                    showErrorMessage("å›¾ç‰‡ç”Ÿæˆå¤±è´¥ã€‚è¯·æ£€æŸ¥æç¤ºè¯æˆ–ç¨åå†è¯•ã€‚"); 
                }
            } catch (error) { 
                showErrorMessage(error.message); 
            } finally {
                setLoadingState('', false);
            }
        });

        detailBtn.addEventListener('click', () => { detailOptions.classList.toggle('hidden'); });

        async function generateDetailImage(prompt) {
            if (!currentImageData) { showErrorMessage("è¯·å…ˆç”Ÿæˆä¸»è®¾è®¡å›¾ã€‚"); return; }
            if (!checkApiLimit()) return;
            setLoadingState('æ­£åœ¨æ·±åŒ–è®¾è®¡ç»†èŠ‚...', true, true);
            detailImage.classList.add('hidden');
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: currentImageData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
            try {
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64Data) {
                    detailImage.src = `data:image/png;base64,${base64Data}`;
                    detailImage.classList.remove('hidden');
                    detailImageTitle.classList.remove('hidden');
                } else { showErrorMessage("ç»†èŠ‚å›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            } catch (error) { showErrorMessage(error.message); } finally { setLoadingState('', false, true); }
        }

        detailOptions.addEventListener('click', async (event) => {
            event.preventDefault();
            if (event.target.tagName !== 'A') return;
            const detailPrompt = event.target.dataset.detailPrompt;
            detailOptions.classList.add('hidden');
            if (detailPrompt === 'custom') { customDetailModal.classList.remove('hidden'); } else { generateDetailImage(detailPrompt); }
        });

        closeCustomModalBtn.addEventListener('click', () => { customDetailModal.classList.add('hidden'); });
        submitCustomDetailBtn.addEventListener('click', () => {
            const customPrompt = customDetailInput.value.trim();
            if (customPrompt) {
                customDetailModal.classList.add('hidden');
                generateDetailImage(customPrompt);
                customDetailInput.value = '';
            } else { showErrorMessage("è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); }
        });
        
        storyBtn.addEventListener('click', async () => {
            if (!currentImageData) { showErrorMessage("è¯·å…ˆç”Ÿæˆå›¾ç‰‡ã€‚"); return; }
            if (!checkApiLimit()) return;
            setLoadingState('æ­£åœ¨ç”Ÿæˆè®¾è®¡è¯´æ˜...', true, true);
            const storyPrompt = storyPromptInput.value.trim();
            const englishPromptForStory = englishPrompt.textContent.trim();
            let combinedPrompt = storyPrompt ? `è¯·éµå¾ªè¿™æ¡æŒ‡ä»¤ï¼šâ€œ${storyPrompt}â€ã€‚æ ¹æ®è¿™æ¡æŒ‡ä»¤ï¼Œå¹¶ç»“åˆæä¾›çš„æœè£…å›¾ç‰‡åŠå…¶åŸå§‹è‹±æ–‡æç¤ºè¯ï¼Œæ’°å†™ä¸€ä»½è®¾è®¡è¯´æ˜ã€‚è¯·åªç”¨ä¸­æ–‡å›ç­”ã€‚åŸå§‹å›¾ç‰‡æç¤ºè¯æ˜¯ï¼šâ€œ${englishPromptForStory}â€ã€‚` : `è¯·æ ¹æ®ä¸‹é¢çš„æœè£…å›¾ç‰‡å’Œå®ƒçš„åŸå§‹è‹±æ–‡æç¤ºè¯ï¼Œæ’°å†™ä¸€ä»½ç®€çŸ­çš„è®¾è®¡è¯´æ˜ã€‚å†…å®¹å¯ä»¥åŒ…æ‹¬å…¶è®¾è®¡çµæ„Ÿã€å»“å½¢ã€é¢æ–™é€‰æ‹©å’Œè‰ºæœ¯é£æ ¼ã€‚è¯·åªç”¨ä¸­æ–‡å›ç­”ã€‚åŸå§‹æç¤ºè¯æ˜¯ï¼šâ€œ${englishPromptForStory}â€ã€‚`;
            const payload = { contents: [{ role: "user", parts: [{ text: combinedPrompt }, { inlineData: { mimeType: "image/png", data: currentImageData } }] }], };
            try {
                const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const story = response.candidates[0].content.parts[0].text;
                storyText.textContent = story;
                storyContainer.classList.remove('hidden');
            } catch (error) { showErrorMessage(error.message); } finally { setLoadingState('', false, true); }
        });

        copyStoryBtn.addEventListener('click', () => {
            const textToCopy = storyText.textContent;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                const originalText = copyStoryBtn.textContent;
                copyStoryBtn.textContent = 'å·²å¤åˆ¶ï¼';
                setTimeout(() => { copyStoryBtn.textContent = originalText; }, 2000);
            } catch (err) { showErrorMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚'); } finally { document.body.removeChild(tempTextArea); }
        });

        lineartBtn.addEventListener('click', () => { lineartModal.classList.remove('hidden'); });
        closeLineartModalBtn.addEventListener('click', () => { lineartModal.classList.add('hidden'); });
        
        lineartGenerateBtn.addEventListener('click', async () => {
            const query = lineartInput.value.trim();
            if (!query) return;

            if (!checkApiLimit()) return;
            lineartLoadingMessage.textContent = "æ­£åœ¨ç”Ÿæˆè®¾è®¡çº¿ç¨¿...";
            lineartLoading.classList.remove('hidden');
            lineartResults.innerHTML = '';
            currentLineArtData = null;

            const lineArtPrompt = `Create a clean, clear, black and white vector fashion illustration line art, similar to a coloring book page or a technical flat sketch. The image should have distinct, closed-off areas. Do not include any shading, colors, or numbers. The subject is: "${query}"`;
            const payload = { contents: [{ parts: [{ text: lineArtPrompt }] }], generationConfig: { responseModalities: ["IMAGE"] }, };

            try {
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64Data) {
                    currentLineArtData = base64Data;
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    lineartResults.innerHTML = `
                        <div class="flex flex-col gap-4 items-center">
                            <div id="lineart-original-wrapper">
                                <h4 class="font-bold text-lg mb-2">åŸå§‹çº¿ç¨¿</h4>
                                <img src="${imageUrl}" class="max-w-full h-auto mx-auto rounded-lg shadow-md" alt="Original Line Art">
                            </div>
                            <div id="lineart-modified-wrapper"></div>
                        </div>
                        <div id="lineart-controls" class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                             <a id="lineart-download-link" href="${imageUrl}" download="fashion-line-art.png" class="px-4 py-2 text-white font-bold rounded-full shadow-lg btn btn-secondary">ä¸‹è½½çº¿ç¨¿</a>
                            <div class="relative">
                                <button id="lineart-modify-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn btn-quintenary">
                                    <span>æ¶¦è‰² ğŸ¨</span>
                                </button>
                                <div id="lineart-modify-options" class="absolute bottom-full mb-2 w-max bg-white rounded-md shadow-lg z-10 hidden text-left">
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚... (æ‰‹åŠ¨è¾“å…¥)</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Color this line art with a simple, flat color palette.">ä¸€é”®ä¸Šè‰²</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Redraw this in a more minimalist, simplified style.">æ›´æç®€</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Redraw this with more intricate and exquisite details.">æ›´ç²¾è‡´</a>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('lineart-modify-btn').addEventListener('click', () => {
                        document.getElementById('lineart-modify-options').classList.toggle('hidden');
                    });
                    document.getElementById('lineart-modify-options').addEventListener('click', (event) => {
                        event.preventDefault();
                        if (event.target.tagName !== 'A') return;
                        const detailPrompt = event.target.dataset.detailPrompt;
                        document.getElementById('lineart-modify-options').classList.add('hidden');
                        if (detailPrompt === 'custom') { 
                            lineartCustomDetailModal.classList.remove('hidden'); 
                        } else { 
                            handleLineartModify(detailPrompt); 
                        }
                    });

                } else {
                    lineartResults.innerHTML = `<p class="text-center text-gray-500">æ— æ³•ç”Ÿæˆçº¿ç¨¿ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯ã€‚</p>`;
                }
            } catch (error) {
                lineartResults.innerHTML = `<p class="text-center text-red-500">ç”Ÿæˆå¤±è´¥ï¼š${error.message}</p>`;
            } finally {
                lineartLoading.classList.add('hidden');
            }
        });
        
        async function handleLineartModify(prompt) {
            if (!prompt || !currentLineArtData) return;
            if (!checkApiLimit()) return;

            lineartLoadingMessage.textContent = "æ­£åœ¨æ¶¦è‰²...";
            lineartLoading.classList.remove('hidden');
            
            const modifyPrompt = `Based on the provided fashion line art, redraw it with the following modification: "${prompt}"`;
            const payload = { contents: [{ role: "user", parts: [{ text: modifyPrompt }, { inlineData: { mimeType: "image/png", data: currentLineArtData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, };

            try {
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    const modifiedWrapper = document.getElementById('lineart-modified-wrapper');
                    modifiedWrapper.innerHTML = `
                        <h4 class="font-bold text-lg mb-2">æ¶¦è‰²å</h4>
                        <img src="${imageUrl}" class="max-w-full h-auto mx-auto rounded-lg shadow-md" alt="Modified Line Art">
                    `;
                    document.getElementById('lineart-download-link').href = imageUrl; 
                } else {
                    showErrorMessage('æ¶¦è‰²å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
                }
            } catch (error) {
                showErrorMessage(`æ¶¦è‰²å¤±è´¥: ${error.message}`);
            } finally {
                lineartLoading.classList.add('hidden');
            }
        }
        
        lineartCloseCustomModalBtn.addEventListener('click', () => lineartCustomDetailModal.classList.add('hidden'));
        lineartSubmitCustomDetailBtn.addEventListener('click', () => {
            const customPrompt = lineartCustomDetailInput.value.trim();
            if (customPrompt) {
                lineartCustomDetailModal.classList.add('hidden');
                handleLineartModify(customPrompt);
                lineartCustomDetailInput.value = '';
            } else { showErrorMessage("è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); }
        });

        encyclopediaToggle.addEventListener('click', () => { encyclopediaModal.classList.remove('hidden'); });
        closeEncyclopediaModalBtn.addEventListener('click', () => { encyclopediaModal.classList.add('hidden'); });
        encyclopediaSearchBtn.addEventListener('click', async () => {
            const query = encyclopediaInput.value.trim();
            if (!query) return;

            encyclopediaLoading.classList.remove('hidden');
            encyclopediaResults.innerHTML = '';

            try {
                if (!checkApiLimit()) return;
                const translationPayload = { contents: [{ parts: [{ text: `Translate the following Chinese query into a concise, effective English search query: "${query}"` }] }] };
                const translationResponse = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(translationPayload) });
                incrementApiUsage();
                if (!translationResponse || !translationResponse.candidates) throw new Error("æœç´¢ç¿»è¯‘å¤±è´¥ã€‚");
                const englishQuery = translationResponse.candidates[0].content.parts[0].text.trim();
                
                let systemPrompt;
                const detailedKeywords = ['é“¾æ¥', 'ç½‘å€', 'æ–‡çŒ®', 'è§†é¢‘', 'link', 'url', 'literature', 'video', 'source'];
                if (detailedKeywords.some(keyword => query.includes(keyword))) {
                    systemPrompt = "You are a helpful research assistant specializing in fashion design, textiles, and fashion history. When a user provides a query, use Google Search to find relevant information. Provide a concise summary of the topic based on the search results. Then, list the top 3-5 most relevant sources with their titles and URLs. Respond in Chinese.";
                } else {
                    systemPrompt = "You are a helpful research assistant specializing in fashion design, textiles, and fashion history. When a user provides a query, use Google Search to find relevant information and provide a concise summary of the topic. Do not include any links or sources unless specifically asked. Respond in Chinese.";
                }

                const userQuery = `Find information about: "${englishQuery}"`;
                
                if (!checkApiLimit()) return;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetchWithRetry(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                incrementApiUsage();

                const candidate = response?.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const summaryText = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                            .filter(source => source.uri && source.title);
                    }

                    const summaryEl = document.createElement('div');
                    summaryEl.className = 'p-4 bg-gray-50 rounded-lg';
                    summaryEl.innerHTML = `<h4 class="font-bold text-lg mb-2">æ‘˜è¦</h4><p class="text-gray-700">${summaryText.replace(/\n/g, '<br>')}</p>`;
                    encyclopediaResults.appendChild(summaryEl);

                    if (sources.length > 0) {
                        const sourcesEl = document.createElement('div');
                        sourcesEl.className = 'p-4';
                        let sourcesHTML = '<h4 class="font-bold text-lg mb-2">ç›¸å…³èµ„æ–™</h4><ul class="space-y-2 list-disc list-inside">';
                        sources.forEach(source => {
                            sourcesHTML += `<li><a href="${source.uri}" target="_blank" class="text-indigo-600 hover:underline">${source.title}</a></li>`;
                        });
                        sourcesHTML += '</ul>';
                        sourcesEl.innerHTML = sourcesHTML;
                        encyclopediaResults.appendChild(sourcesEl);
                    }
                } else {
                    encyclopediaResults.innerHTML = `<p class="text-center text-gray-500">æœªèƒ½æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯ã€‚</p>`;
                }
            } catch (error) {
                showErrorMessage(error.message);
            } finally {
                encyclopediaLoading.classList.add('hidden');
            }
        });

        notebookToggle.addEventListener('click', () => {
            notebookPanel.classList.toggle('hidden');
        });

        let saveTimeout;
        notebookTextarea.addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem('fashionNotebookContent', notebookTextarea.value);
                notebookStatus.classList.remove('opacity-0');
                setTimeout(() => notebookStatus.classList.add('opacity-0'), 2000);
            }, 500); 
        });

        notebookCopyBtn.addEventListener('click', () => {
            const textToCopy = notebookTextarea.value;
            if (!textToCopy) return;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                const originalText = notebookCopyBtn.textContent;
                notebookCopyBtn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => { notebookCopyBtn.textContent = originalText; }, 2000);
            } catch (err) {
                showErrorMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        });

        notebookClearBtn.addEventListener('click', () => {
            notebookTextarea.value = '';
            localStorage.removeItem('fashionNotebookContent');
        });

        copyPromptBtn.addEventListener('click', () => {
            const textToCopy = englishPrompt.textContent;
            if (!textToCopy) return;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                const originalText = copyPromptBtn.textContent;
                copyPromptBtn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => { copyPromptBtn.textContent = originalText; }, 2000);
            } catch (err) {
                showErrorMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        });
        
        // --- ä¸»å›¾ç”Ÿå›¾é¡µé¢é€»è¾‘ ---
        i2iImageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result.split(',')[1];
                uploadedImageData = base64String;
                uploadedImagePreview.src = e.target.result;
                uploadedImageContainer.classList.remove('hidden');
                analyzeBtn.disabled = false;
                directModifyBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        });

        analyzeBtn.addEventListener('click', async () => {
            if (!uploadedImageData) {
                showErrorMessage("è¯·å…ˆä¸Šä¼ ä¸€å¼ å›¾ç‰‡ã€‚");
                return;
            }

            setI2ILoadingState('æ­£åœ¨åˆ†æå›¾ç‰‡...');
            analysisContainer.classList.add('hidden');
            i2iGeneratedImageContainer.classList.add('hidden');
            i2iDetailControls.classList.add('hidden');

            try {
                if (!checkApiLimit()) return;
                const analysisPrompt = `You are an AI assistant for fashion design. Analyze the following image. First, provide a concise and precise description of its key visual elements, style, and subject matter, suitable for an AI image generator. Then, add a section with directional suggestions on how this image could be translated into a new fashion design, mentioning potential garment types, fabric choices, or silhouettes that would fit the theme. Keep the entire response evocative but not overly complex or long. Respond in English.`;
                const payload = { contents: [{ role: "user", parts: [{ text: analysisPrompt }, { inlineData: { mimeType: "image/jpeg", data: uploadedImageData } }] }], };
                const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                if (!response?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error("AIåˆ†æå¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆæè¿°ã€‚");
                }
                originalAnalysisPrompt = response.candidates[0].content.parts[0].text;
                
                if (!checkApiLimit()) return;
                const translationPayload = { contents: [{ parts: [{ text: `Translate the following English text to Chinese: "${originalAnalysisPrompt}"` }] }] };
                const translationResponse = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(translationPayload) });
                incrementApiUsage();
                const chineseAnalysis = translationResponse.candidates[0].content.parts[0].text.trim();
                analysisText.value = chineseAnalysis;
                analysisContainer.classList.remove('hidden');

            } catch (error) {
                showErrorMessage(error.message);
            } finally {
                setI2ILoadingState('', false);
            }
        });

        generateFromAnalysisBtn.addEventListener('click', async () => {
            const editedChineseAnalysis = analysisText.value.trim();
            if(!editedChineseAnalysis) {
                showErrorMessage("åˆ†ææ–‡æœ¬ä¸èƒ½ä¸ºç©ºã€‚");
                return;
            }

            setI2ILoadingState('æ­£åœ¨æ ¹æ®åˆ†æç”Ÿæˆæ–°è®¾è®¡...');
            i2iGeneratedImageContainer.classList.add('hidden');
            i2iDetailControls.classList.add('hidden');

            try {
                if (!checkApiLimit()) return;
                 const translationPayload = { contents: [{ parts: [{ text: `Translate the following Chinese text into a detailed, high-quality English prompt for an AI image generator for fashion: "${editedChineseAnalysis}"` }] }] };
                const translationResponse = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(translationPayload) });
                incrementApiUsage();
                const finalEngPrompt = translationResponse.candidates[0].content.parts[0].text.trim();

                if (!checkApiLimit()) return;
                const payload = { contents: [{ parts: [{ text: finalEngPrompt }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    currentI2IImageData = base64Data;
                    baseI2IImageData = base64Data; // Save as the base image for modifications
                    i2iGeneratedImage.src = `data:image/png;base64,${base64Data}`;
                    i2iAfterTitle.textContent = 'æ ¹æ®åˆ†æç”Ÿæˆçš„æ–°è®¾è®¡';
                    i2iBeforeContainer.classList.add('hidden');
                    i2iGeneratedImageContainer.classList.remove('hidden');
                    i2iDetailControls.style.display = 'flex';
                } else {
                    showErrorMessage("ç”Ÿæˆæ–°è®¾è®¡å¤±è´¥ã€‚");
                }
            } catch(error) {
                showErrorMessage(error.message);
            } finally {
                setI2ILoadingState('', false);
            }
        });


        directModifyBtn.addEventListener('click', () => { directModifyOptions.classList.toggle('hidden'); });

        async function generateUploadedImageDetail(prompt) {
             if (!uploadedImageData) { showErrorMessage("è¯·å…ˆä¸Šä¼ ä¸€å¼ å›¾ç‰‡ã€‚"); return; }
             if (!checkApiLimit()) return;
            setI2ILoadingState('æ­£åœ¨ä¿®æ”¹ä¸Šä¼ çš„å›¾ç‰‡...');
            analysisContainer.classList.add('hidden');
            i2iGeneratedImageContainer.classList.add('hidden');
            i2iDetailControls.style.display = 'none';
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: uploadedImageData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
            try {
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64Data) {
                    currentI2IImageData = base64Data;
                    baseI2IImageData = base64Data; // This is a new base image
                    i2iGeneratedImage.src = `data:image/png;base64,${base64Data}`;
                    i2iAfterTitle.textContent = 'ä¿®æ”¹å';
                    
                    i2iBeforeImage.src = uploadedImagePreview.src;
                    i2iBeforeContainer.classList.remove('hidden');

                    i2iGeneratedImageContainer.classList.remove('hidden');
                    i2iDetailControls.style.display = 'flex';
                } else { showErrorMessage("ä¿®æ”¹å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            } catch (error) { showErrorMessage(error.message); } finally { setI2ILoadingState('', false); }
        }

        directModifyOptions.addEventListener('click', async (event) => {
            event.preventDefault();
            if (event.target.tagName !== 'A') return;
            const detailPrompt = event.target.dataset.detailPrompt;
            directModifyOptions.classList.add('hidden');
            if (detailPrompt === 'custom') { 
                i2iCustomDetailModal.dataset.source = 'direct';
                i2iCustomDetailModal.classList.remove('hidden'); 
            } else { 
                generateUploadedImageDetail(detailPrompt); 
            }
        });

        i2iDetailBtn.addEventListener('click', () => { i2iDetailOptions.classList.toggle('hidden'); });

        async function generateI2IDetailImage(prompt) {
            if (!baseI2IImageData) { showErrorMessage("è¯·å…ˆæ ¹æ®åˆ†æç”Ÿæˆä¸€ä¸ªåŸºç¡€è®¾è®¡ã€‚"); return; }
            if (!checkApiLimit()) return;
            setI2ILoadingState('æ­£åœ¨æ·±åŒ–å›¾ç”Ÿå›¾è®¾è®¡...');
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: baseI2IImageData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
            try {
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64Data) {
                    i2iBeforeImage.src = `data:image/png;base64,${baseI2IImageData}`;
                    i2iBeforeContainer.classList.remove('hidden');
                    
                    currentI2IImageData = base64Data; // Update the current image for display only
                    i2iGeneratedImage.src = `data:image/png;base64,${base64Data}`;
                    i2iAfterTitle.textContent = 'ä¿®æ”¹å';
                } else { showErrorMessage("ç»†èŠ‚å›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            } catch (error) { showErrorMessage(error.message); } finally { setI2ILoadingState('', false); }
        }

        i2iDetailOptions.addEventListener('click', async (event) => {
            event.preventDefault();
            if (event.target.tagName !== 'A') return;
            const detailPrompt = event.target.dataset.detailPrompt;
            i2iDetailOptions.classList.add('hidden');
            if (detailPrompt === 'custom') { 
                i2iCustomDetailModal.dataset.source = 'i2i';
                i2iCustomDetailModal.classList.remove('hidden'); 
            } else { 
                generateI2IDetailImage(detailPrompt); 
            }
        });

        i2iCloseCustomModalBtn.addEventListener('click', () => { i2iCustomDetailModal.classList.add('hidden'); });
        i2iSubmitCustomDetailBtn.addEventListener('click', () => {
            const customPrompt = i2iCustomDetailInput.value.trim();
            if (customPrompt) {
                i2iCustomDetailModal.classList.add('hidden');
                const source = i2iCustomDetailModal.dataset.source;
                if(source === 'direct'){
                    generateUploadedImageDetail(customPrompt);
                } else { // source === 'i2i'
                    generateI2IDetailImage(customPrompt);
                }
                i2iCustomDetailInput.value = '';
            } else { showErrorMessage("è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); }
        });
        
        // --- çº¿ç¨¿æ¨¡æ€æ¡†ä¸Šä¼ ä¸å›¾ç”Ÿå›¾å‡½æ•° ---
        lineartUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result.split(',')[1];
                uploadedLineartImageData = base64String;
                lineartUploadPreview.src = e.target.result;
                lineartUploadPreviewContainer.classList.remove('hidden');
                lineartUploadAnalyzeBtn.disabled = false;
                lineartUploadModifyBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        });

        lineartUploadAnalyzeBtn.addEventListener('click', async () => {
            if (!uploadedLineartImageData) {
                showErrorMessage("è¯·å…ˆä¸Šä¼ ä¸€å¼ å›¾ç‰‡ã€‚");
                return;
            }
            lineartUploadLoadingMessage.textContent = "æ­£åœ¨åˆ†æä¸Šä¼ çš„çº¿ç¨¿...";
            lineartUploadLoading.classList.remove('hidden');
            lineartUploadAnalysisContainer.classList.add('hidden');
            lineartUploadGeneratedImageContainer.classList.add('hidden');
            lineartUploadDetailControls.classList.add('hidden');

            try {
                if (!checkApiLimit()) return;
                 const analysisPrompt = `You are an expert art critic and AI prompt engineer specializing in fashion. Analyze the provided image using Google Search to identify potential designers or styles, then generate a description following this exact structure:
1.  **Style Identification:** Start with a sentence identifying the dominant style (e.g., "This is a striking minimalist fashion illustration," or "This is a detailed technical flat sketch.").
2.  **Designer/Influence:** In a new sentence, suggest a possible designer or stylistic influence. If you cannot identify a specific designer after searching, state "ä½œè€…ä¸è¯¦ (Author unknown), but the style is reminiscent of..." or a similar phrase.
3.  **Content Description:** Describe the garment and key elements of the artwork.
4.  **Technical and Tool Analysis:** Describe the use of colors and lines. Based on the line quality, texture, and medium characteristics, identify the likely tool used (e.g., 'This appears to be created with a marker pen,' 'The texture suggests colored pencils,' 'This is a digital vector illustration.').
5.  **Overall Impression:** Conclude with a sentence about the overall mood or effect, mentioning the background.

The entire analysis should be concise, precise, and serve as a high-quality, detailed prompt for generating a new, fully rendered fashion image based on this analysis. Respond in English.`;
                const payload = { 
                    contents: [{ role: "user", parts: [{ text: analysisPrompt }, { inlineData: { mimeType: "image/jpeg", data: uploadedLineartImageData } }] }],
                    tools: [{ "google_search": {} }],
                };
                const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                if (!response?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error("AIåˆ†æå¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆæè¿°ã€‚");
                }
                const englishAnalysis = response.candidates[0].content.parts[0].text;
                
                if (!checkApiLimit()) return;
                const translationPayload = { contents: [{ parts: [{ text: `Translate the following English text to Chinese: "${englishAnalysis}"` }] }] };
                const translationResponse = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(translationPayload) });
                incrementApiUsage();
                const chineseAnalysis = translationResponse.candidates[0].content.parts[0].text.trim();
                lineartUploadAnalysisText.value = chineseAnalysis;
                lineartUploadAnalysisContainer.classList.remove('hidden');

            } catch (error) {
                showErrorMessage(error.message);
            } finally {
                lineartUploadLoading.classList.add('hidden');
            }
        });

        lineartUploadGenerateFromAnalysisBtn.addEventListener('click', async () => {
            const editedChineseAnalysis = lineartUploadAnalysisText.value.trim();
            if(!editedChineseAnalysis) {
                showErrorMessage("åˆ†ææ–‡æœ¬ä¸èƒ½ä¸ºç©ºã€‚");
                return;
            }
            lineartUploadLoadingMessage.textContent = "æ­£åœ¨æ ¹æ®åˆ†æç”Ÿæˆæ–°è®¾è®¡...";
            lineartUploadLoading.classList.remove('hidden');
            lineartUploadGeneratedImageContainer.classList.add('hidden');
            lineartUploadDetailControls.classList.add('hidden');

            try {
                if (!checkApiLimit()) return;
                const translationPayload = { contents: [{ parts: [{ text: `Translate the following Chinese text into a detailed, high-quality English prompt for an AI image generator for fashion: "${editedChineseAnalysis}"` }] }] };
                const translationResponse = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(translationPayload) });
                incrementApiUsage();
                const finalEngPrompt = translationResponse.candidates[0].content.parts[0].text.trim();

                if (!checkApiLimit()) return;
                const payload = { contents: [{ parts: [{ text: finalEngPrompt }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    currentLineartUploadI2IImageData = base64Data;
                    baseLineartUploadI2IImageData = base64Data; // Save as base image
                    lineartUploadGeneratedImage.src = `data:image/png;base64,${base64Data}`;

                    lineartUploadAfterTitle.textContent = 'ç”Ÿæˆçš„æ–°è®¾è®¡';
                    lineartUploadBeforeContainer.classList.add('hidden');
                    
                    lineartUploadGeneratedImageContainer.classList.remove('hidden');
                    lineartUploadDetailControls.classList.remove('hidden');
                } else {
                    showErrorMessage("ç”Ÿæˆæ–°è®¾è®¡å¤±è´¥ã€‚");
                }
            } catch(error) {
                showErrorMessage(error.message);
            } finally {
                lineartUploadLoading.classList.add('hidden');
            }
        });
        
        lineartUploadModifyBtn.addEventListener('click', () => {
            lineartUploadModifyOptions.classList.toggle('hidden');
        });

        lineartUploadModifyOptions.addEventListener('click', (event) => {
            event.preventDefault();
            lineartUploadModifyOptions.classList.add('hidden');
            lineartUploadCustomDetailModal.dataset.source = 'direct_modify';
            lineartUploadCustomDetailModal.classList.remove('hidden');
        });

        async function generateLineartUploadDirectModificationImage(prompt) {
            if (!uploadedLineartImageData) {
                showErrorMessage("è¯·å…ˆä¸Šä¼ ä¸€å¼ å›¾ç‰‡ã€‚");
                return;
            }
            if (!checkApiLimit()) return;
            lineartUploadLoadingMessage.textContent = "æ­£åœ¨ä¿®æ”¹å›¾ç‰‡...";
            lineartUploadLoading.classList.remove('hidden');
            lineartUploadGeneratedImageContainer.classList.add('hidden');

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: uploadedLineartImageData } }] }],
                generationConfig: { responseModalities: ["IMAGE"] },
            };

            try {
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    baseLineartUploadI2IImageData = base64Data;
                    currentLineartUploadI2IImageData = base64Data;

                    lineartUploadBeforeImage.src = lineartUploadPreview.src;
                    lineartUploadBeforeContainer.classList.remove('hidden');

                    lineartUploadGeneratedImage.src = `data:image/png;base64,${base64Data}`;
                    lineartUploadAfterTitle.textContent = 'ä¿®æ”¹å';
                    
                    lineartUploadGeneratedImageContainer.classList.remove('hidden');
                    lineartUploadDetailControls.classList.remove('hidden');
                } else {
                    showErrorMessage("ä¿®æ”¹å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
                }
            } catch (error) {
                showErrorMessage(`ä¿®æ”¹å¤±è´¥ï¼š${error.message}`);
            } finally {
                lineartUploadLoading.classList.add('hidden');
            }
        }


        lineartUploadDetailBtn.addEventListener('click', () => lineartUploadDetailOptions.classList.toggle('hidden'));

        async function generateLineartUploadI2IDetailImage(prompt) {
            if (!baseLineartUploadI2IImageData) { showErrorMessage("è¯·å…ˆæ ¹æ®çº¿ç¨¿åˆ†æç”Ÿæˆä¸€å¼ å›¾ç‰‡ã€‚"); return; }
            if (!checkApiLimit()) return;
            lineartUploadLoadingMessage.textContent = "æ­£åœ¨ä¿®æ”¹æ¶¦è‰²...";
            lineartUploadLoading.classList.remove('hidden');
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: baseLineartUploadI2IImageData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
            try {
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                incrementApiUsage();
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64Data) {
                    lineartUploadBeforeImage.src = `data:image/png;base64,${baseLineartUploadI2IImageData}`;
                    lineartUploadBeforeContainer.classList.remove('hidden');
                    
                    currentLineartUploadI2IImageData = base64Data; // Update current for display
                    lineartUploadGeneratedImage.src = `data:image/png;base64,${base64Data}`;
                    lineartUploadAfterTitle.textContent = 'ä¿®æ”¹å';
                } else { showErrorMessage("ç»†èŠ‚å›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            } catch (error) { showErrorMessage(error.message); } finally { lineartUploadLoading.classList.add('hidden'); }
        }
        
        lineartUploadDetailOptions.addEventListener('click', (event) => {
            event.preventDefault();
            if (event.target.tagName !== 'A') return;
            const detailPrompt = event.target.dataset.detailPrompt;
            lineartUploadDetailOptions.classList.add('hidden');
            if (detailPrompt === 'custom') { 
                lineartUploadCustomDetailModal.dataset.source = 'detail_modify';
                lineartUploadCustomDetailModal.classList.remove('hidden'); 
            } else { 
                generateLineartUploadI2IDetailImage(detailPrompt); 
            }
        });
        
        lineartUploadCloseCustomModalBtn.addEventListener('click', () => lineartUploadCustomDetailModal.classList.add('hidden'));
        lineartUploadSubmitCustomDetailBtn.addEventListener('click', () => {
            const customPrompt = lineartUploadCustomDetailInput.value.trim();
            if (customPrompt) {
                lineartUploadCustomDetailModal.classList.add('hidden');
                const source = lineartUploadCustomDetailModal.dataset.source;
                if(source === 'direct_modify') {
                    generateLineartUploadDirectModificationImage(customPrompt);
                } else {
                    generateLineartUploadI2IDetailImage(customPrompt);
                }
                lineartUploadCustomDetailInput.value = '';
            } else { showErrorMessage("è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); }
        });

        copyAnalysisBtn.addEventListener('click', () => {
            const textToCopy = analysisText.value;
            if (!textToCopy) return;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                const originalText = copyAnalysisBtn.textContent;
                copyAnalysisBtn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => { copyAnalysisBtn.textContent = originalText; }, 2000);
            } catch (err) {
                showErrorMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        });
        
        lineartUploadCopyAnalysisBtn.addEventListener('click', () => {
            const textToCopy = lineartUploadAnalysisText.value;
            if (!textToCopy) return;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                const originalText = lineartUploadCopyAnalysisBtn.textContent;
                lineartUploadCopyAnalysisBtn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => { lineartUploadCopyAnalysisBtn.textContent = originalText; }, 2000);
            } catch (err) {
                showErrorMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        });

        // --- é¡µé¢è·¯ç”± ---
        const goToI2IButton = document.getElementById('go-to-i2i');
        const goToMainButton = document.getElementById('go-to-main');

        goToI2IButton.addEventListener('click', () => {
            mainPage.classList.add('hidden');
            i2iPage.classList.remove('hidden');
        });

        goToMainButton.addEventListener('click', () => {
            i2iPage.classList.add('hidden');
            mainPage.classList.remove('hidden');
        });

    </script>
</body>
</html>

